<!DOCTYPE html>
<html>
    <head>
        <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0lT-ulZjyaKKQI4ECtOmzPILwp1ewv10&callback=initMap"></script>
        <style>
            #map {
                height: 100%;
            }
            html,
            body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            .info-window {
                display: block;
            }
            .info-window h3 {
                font-size: 1.6rem;
            }
            .info-window p, .info-window a {
                font-size: 1.2rem;
            }
            .info-window a  {
                color: #9d55d4;
                text-decoration: none;
            }
            .info-window a:hover {
                text-decoration: underline;
            }
            .flex {
                display: flex;
                align-items: center;
            }
            .flex h3 {
                margin-right: 12px;
            }
            .gm-ui-hover-effect {
                margin: 10px !important;
            }
            .gm-ui-hover-effect span {
                margin: 0 !important;
            }
            .gm-ui-hover-effect, .gm-ui-hover-effect span {
                font-size: 1rem;
                width: 32px !important;
                height: 32px !important;
            }
            .svg-icon {
                color: #9D55D4;
                width: 20px;
                margin: 8px;
            }

            @media only screen and (max-width: 749px) {
                .info-window h3 {
                    font-size: 1.2rem;
                }
                .info-window p {
                    font-size: 1rem;
                }
            }
        </style>
        <title>Stylist Locator</title>
    </head>
    <body>
        <div id="map"></div>
        <script>
        async function fetchStylistsFromWixAPI() {
            const response = await fetch("https://service-finder-api-proxy.herokuapp.com/stylistsAPI");
            const data = await response.json();
            // console.log('wix data...', data);
            return data.stylists; // get the stylists array from the response body
        }

        let openInfoWindow = null;

        async function createMarkerFromAddress(map, address, content, setVisible = false) {
            const geocoder = new google.maps.Geocoder();

            const getLocationFromAddress = (address) => {
                return new Promise((resolve, reject) => {
                    geocoder.geocode({ address }, (results, status) => {
                        if (status === "OK") {
                            resolve(results[0].geometry.location);
                        } else {
                            reject(new Error(`Geocode failed for address: ${address}, status: ${status}`));
                        }
                    });
                });
            };

            try {
                const location = await getLocationFromAddress(address);
                const marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    visible: setVisible,
                    icon: 'https://lfranckx.github.io/hhng-service-finder/marker.png'
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: content,
                });

                marker.addListener("click", () => {
                    if (openInfoWindow) {
                        openInfoWindow.close();
                    }
                    infoWindow.open(map, marker);
                    openInfoWindow = infoWindow;
                });
                return { marker, infoWindow };
            } catch (error) {
                console.error(error);
            }
        }

        async function initMapAsync() {
            await new Promise((resolve) => {
                window.initMap = () => {
                    resolve();
                };
            });

            const position = { lat: 37.0902, lng: -95.7129 };

            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 4,
                center: position,
            });

            map.data.loadGeoJson("https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json");

            // Map to store all markers by state
            const markersByState = new Map();

            // Map of US state abbreviations to full names
            const stateAbbreviations = new Map([
                ["AL", "Alabama"],
                ["AK", "Alaska"],
                ["AZ", "Arizona"],
                ["AR", "Arkansas"],
                ["CA", "California"],
                ["CO", "Colorado"],
                ["CT", "Connecticut"],
                ["DE", "Delaware"],
                ["FL", "Florida"],
                ["GA", "Georgia"],
                ["HI", "Hawaii"],
                ["ID", "Idaho"],
                ["IL", "Illinois"],
                ["IN", "Indiana"],
                ["IA", "Iowa"],
                ["KS", "Kansas"],
                ["KY", "Kentucky"],
                ["LA", "Louisiana"],
                ["ME", "Maine"],
                ["MD", "Maryland"],
                ["MA", "Massachusetts"],
                ["MI", "Michigan"],
                ["MN", "Minnesota"],
                ["MS", "Mississippi"],
                ["MO", "Missouri"],
                ["MT", "Montana"],
                ["NE", "Nebraska"],
                ["NV", "Nevada"],
                ["NH", "New Hampshire"],
                ["NJ", "New Jersey"],
                ["NM", "New Mexico"],
                ["NY", "New York"],
                ["NC", "North Carolina"],
                ["ND", "North Dakota"],
                ["OH", "Ohio"],
                ["OK", "Oklahoma"],
                ["OR", "Oregon"],
                ["PA", "Pennsylvania"],
                ["RI", "Rhode Island"],
                ["SC", "South Carolina"],
                ["SD", "South Dakota"],
                ["TN", "Tennessee"],
                ["TX", "Texas"],
                ["UT", "Utah"],
                ["VT", "Vermont"],
                ["VA", "Virginia"],
                ["WA", "Washington"],
                ["WV", "West Virginia"],
                ["WI", "Wisconsin"],
                ["WY", "Wyoming"]
            ]);

            // Fetch stylist data
            const stylists = await fetchStylistsFromWixAPI();

            // Create all markers
            for (const stylist of stylists) {
                const { marker, infoWindow } = await createMarkerFromAddress(
                    map,
                    `${stylist.streetAddress}, ${stylist.city}, ${stateAbbreviations.get(stylist.regionStateProvince) || stylist.regionStateProvince}, ${stylist.postalZipCode}`,
                    `<div class="info-window">
                        <div class='flex'>
                        <h3>${stylist.firstName} ${stylist.lastName}</h3>
                        <p>(${stylist.pronouns})</p>
                        </div>
                        <h3>${stylist.businessName}</h3>
                        <p>${stylist.streetAddress}, ${stylist.city}, ${stateAbbreviations.get(stylist.regionStateProvince) || stylist.regionStateProvince}, ${stylist.postalZipCode}</p>
                        <div class='flex'>
                            <div class='icon-wrap'>
                                <a href='tel:${stylist.phone}'>
                                    <svg class="svg-icon" viewBox="0 0 20 20">
                                        <path d="M14.911,1.295H5.09c-0.737,0-1.339,0.603-1.339,1.339v14.733c0,0.736,0.603,1.338,1.339,1.338h9.821c0.737,0,1.339-0.602,1.339-1.338V2.634C16.25,1.898,15.648,1.295,14.911,1.295 M15.357,17.367c0,0.24-0.205,0.445-0.446,0.445H5.09c-0.241,0-0.446-0.205-0.446-0.445v-0.893h10.714V17.367z M15.357,15.58H4.644V4.42h10.714V15.58z M15.357,3.527H4.644V2.634c0-0.241,0.205-0.446,0.446-0.446h9.821c0.241,0,0.446,0.206,0.446,0.446V3.527z"></path>
                                    </svg>    
                                </a>
                            </div>
                            <div class='icon-wrap'>
                                <a href='mailto:${stylist.email}'>
                                    <svg class="svg-icon" viewBox="0 0 20 20">
                                        <path d="M17.218,2.268L2.477,8.388C2.13,8.535,2.164,9.05,2.542,9.134L9.33,10.67l1.535,6.787c0.083,0.377,0.602,0.415,0.745,0.065l6.123-14.74C17.866,2.46,17.539,2.134,17.218,2.268 M3.92,8.641l11.772-4.89L9.535,9.909L3.92,8.641z M11.358,16.078l-1.268-5.613l6.157-6.157L11.358,16.078z"></path>
                                    </svg>
                                </a>
                            </div>
                            <div>
                                <a class='website_url' href='${stylist.websiteUrl}' target="_blank">
                                    <svg class="svg-icon" viewBox="0 0 20 20">
                                        <path d="M16.469,8.924l-2.414,2.413c-0.156,0.156-0.408,0.156-0.564,0c-0.156-0.155-0.156-0.408,0-0.563l2.414-2.414c1.175-1.175,1.175-3.087,0-4.262c-0.57-0.569-1.326-0.883-2.132-0.883s-1.562,0.313-2.132,0.883L9.227,6.511c-1.175,1.175-1.175,3.087,0,4.263c0.288,0.288,0.624,0.511,0.997,0.662c0.204,0.083,0.303,0.315,0.22,0.52c-0.171,0.422-0.643,0.17-0.52,0.22c-0.473-0.191-0.898-0.474-1.262-0.838c-1.487-1.485-1.487-3.904,0-5.391l2.414-2.413c0.72-0.72,1.678-1.117,2.696-1.117s1.976,0.396,2.696,1.117C17.955,5.02,17.955,7.438,16.469,8.924 M10.076,7.825c-0.205-0.083-0.437,0.016-0.52,0.22c-0.083,0.205,0.016,0.437,0.22,0.52c0.374,0.151,0.709,0.374,0.997,0.662c1.176,1.176,1.176,3.088,0,4.263l-2.414,2.413c-0.569,0.569-1.326,0.883-2.131,0.883s-1.562-0.313-2.132-0.883c-1.175-1.175-1.175-3.087,0-4.262L6.51,9.227c0.156-0.155,0.156-0.408,0-0.564c-0.156-0.156-0.408-0.156-0.564,0l-2.414,2.414c-1.487,1.485-1.487,3.904,0,5.391c0.72,0.72,1.678,1.116,2.696,1.116s1.976-0.396,2.696-1.116l2.414-2.413c1.487-1.486,1.487-3.905,0-5.392C10.974,8.298,10.55,8.017,10.076,7.825"></path>
                                    </svg>    
                                </a>
                            </div>
                            <div>
                                <a class='ig_handle' href='https://www.instagram.com/${stylist.instagramHandle}' target="_blank">
                                    <svg class="svg-icon" viewBox="0 0 20 20">
                                        <path fill="none" d="M17.835,0.438H2.29c-0.954,0-1.727,0.773-1.727,1.727V17.71c0,0.954,0.773,1.728,1.727,1.728h15.545c0.954,0,1.728-0.773,1.728-1.728V2.165C19.562,1.211,18.789,0.438,17.835,0.438 M18.699,17.71c0,0.477-0.388,0.864-0.864,0.864H2.29c-0.477,0-0.863-0.388-0.863-0.864V2.165c0-0.477,0.387-0.863,0.863-0.863h15.545c0.477,0,0.864,0.387,0.864,0.863V17.71zM12.653,5.619H7.472c-0.954,0-1.728,0.773-1.728,1.728v5.182c0,0.954,0.773,1.728,1.728,1.728h5.182c0.954,0,1.728-0.773,1.728-1.728V7.347C14.381,6.393,13.607,5.619,12.653,5.619 M11.79,6.915h1.295V8.21H11.79V6.915z M10.062,8.21c0.954,0,1.728,0.773,1.728,1.727s-0.773,1.728-1.728,1.728c-0.954,0-1.727-0.773-1.727-1.728S9.109,8.21,10.062,8.21M13.518,12.528c0,0.478-0.388,0.863-0.864,0.863H7.472c-0.477,0-0.864-0.386-0.864-0.863V9.505h0.907C7.491,9.647,7.472,9.79,7.472,9.938c0,1.432,1.16,2.591,2.591,2.591c1.432,0,2.591-1.159,2.591-2.591c0-0.148-0.02-0.291-0.044-0.432h0.908V12.528z"></path>
                                    </svg>    
                                </a>
                            </div>
                        </div>
                        <h3>About ${stylist.businessName}:</h3>
                        <p>${stylist.businessDescription}</p>
                    </div>`,
                    false
                );

                const stateName = stateAbbreviations.get(stylist.regionStateProvince) || stylist.regionStateProvince;

                if (!markersByState.has(stateName)) {
                    markersByState.set(stateName, []);
                }

                markersByState.get(stateName).push({ marker, infoWindow });
            }

            const colors = ["#B57EDC", "#4A8122", "#FFF431", "#9B59D0", "#0097D8"];

            // Function to return a random color
            function getRandomColor() {
                return colors[Math.floor(Math.random() * colors.length)];
            }

            // Animate the fill opacity
            function animateFillOpacity(feature, start, end, duration) {
                const startTime = new Date().getTime();
                const interpolate = (current, goal, progress) => {
                    return current + (goal - current) * progress;
                };

                function step() {
                    const currentTime = new Date().getTime();
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    const newOpacity = interpolate(start, end, progress);

                    map.data.overrideStyle(feature, {
                        fillOpacity: newOpacity,
                    });

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    }
                }

                step();
            }

            map.data.addListener("mouseover", (event) => {
                const stateName = event.feature.getProperty("name");
                const stateColor = getRandomColor();
                map.data.overrideStyle(event.feature, {
                    fillColor: stateColor,
                });
                animateFillOpacity(event.feature, 0, 0.5, 260);

                // Check if there are markers for this state
                if (markersByState.has(stateName)) {
                    // Get all markers for this state
                    const markers = markersByState.get(stateName);

                    // Make each marker visible
                    for (const { marker } of markers) {
                        marker.setVisible(true);
                    }
                }
            });

            map.data.addListener("mouseout", (event) => {
                const stateName = event.feature.getProperty("name");
                animateFillOpacity(event.feature, 0.5, 0, 260);

                // Check if there are markers for this state
                if (markersByState.has(stateName)) {
                    // Get all markers for this state
                    const markers = markersByState.get(stateName);

                    // Make each marker invisible
                    for (const { marker } of markers) {
                        marker.setVisible(false);
                    }
                }
            });

            map.data.setStyle((feature) => {
                return {
                    fillColor: "transparent",
                    strokeColor: "#000",
                    strokeWeight: 1,
                    fillOpacity: 0,
                };
            });
        }

        initMapAsync();
        </script>
    </body>
</html>
